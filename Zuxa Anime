import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, WebAppInfo

# –ë–µ—Ä–µ–º —Ç–æ–∫–µ–Ω –∏–∑ Environment Variables –Ω–∞ Render
API_TOKEN = os.getenv("BOT_TOKEN")
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
APP_URL = os.getenv("APP_URL") 

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(KeyboardButton(
        text="üé¨ –û–¢–ö–†–´–¢–¨ –ö–ò–ù–û–¢–ï–ê–¢–†", 
        web_app=WebAppInfo(url=APP_URL) if APP_URL else WebAppInfo(url="https://google.com")
    ))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    return keyboard

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    await message.answer(
        "üçø <b>Zuxa Anime Mini App</b> –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\n\n–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∏–º–µ –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü.",
        reply_markup=main_menu()
    )

# --- –ü–†–û–ö–°–ò –î–õ–Ø API (–ß—Ç–æ–±—ã –∞–Ω–∏–º–µ –∑–∞–≥—Ä—É–∂–∞–ª–æ—Å—å 100%) ---
async def proxy_kodik(request):
    query_type = request.query.get('type', 'list')
    search_query = request.query.get('title', '')
    
    if query_type == 'search':
        url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={search_query}&with_material_data=true"
    else:
        url = f"https://kodikapi.com/list?token={KODIK_TOKEN}&types=anime-serial&limit=15&with_material_data=true&sort=shikimori_rating"
        
    async with aiohttp.ClientSession() as session:
        try:
            async with session.get(url) as resp:
                data = await resp.json()
                return web.json_response(data)
        except Exception as e:
            return web.json_response({"error": str(e)}, status=500)

# --- –†–ê–ó–î–ê–ß–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
async def handle_index(request):
    if os.path.exists('index.html'):
        return web.FileResponse('index.html')
    return web.Response(text="–§–∞–π–ª index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!", status=404)

async def main():
    app = web.Application()
    app.router.add_get('/', handle_index)
    app.router.add_get('/api/anime', proxy_kodik) # –ù–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –º–æ—Å—Ç–∏–∫
    app.router.add_get('/kodik.txt', lambda r: web.Response(text="kodik2349989754"))
    
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, '0.0.0.0', int(os.environ.get("PORT", 8080)))
    await site.start()
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω –Ω–∞ –ü–ö!
    await dp.start_polling()

if __name__ == '__main__':
    asyncio.run(main())
