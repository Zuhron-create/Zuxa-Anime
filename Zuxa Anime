import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
API_TOKEN = os.getenv("BOT_TOKEN")
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
KODIK_CONFIRM_TEXT = "kodik2349989754"

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    # –ö–Ω–æ–ø–∫–∞ –≤ –æ–±—ã—á–Ω–æ–º –º–µ–Ω—é
    keyboard.row(KeyboardButton("üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ"))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    keyboard.row(KeyboardButton("‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ"))
    return keyboard

# –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Kodik
async def handle_kodik_confirm(request):
    return web.Response(text=KODIK_CONFIRM_TEXT)

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–∞–º–∞ –ø–∏—à–µ—Ç @ZuxaAnime_bot
    inline_kb = InlineKeyboardMarkup()
    inline_kb.add(InlineKeyboardButton(
        text="üöÄ –û–¢–ö–†–´–¢–¨ –ü–û–ò–°–ö", 
        switch_inline_query_current_chat="" # –≠—Ç–æ –≤—Å—Ç–∞–≤–∏—Ç –∏–º—è –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    ))

    await message.reply(
        "üçø <b>Zuxa Anime</b> –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–±—è!\n\n"
        "–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ –∞–Ω–∏–º–µ. "
        "–ò–º—è –±–æ—Ç–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!",
        reply_markup=main_menu()
    )
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
    await message.answer("–ù–∞–∂–º–∏ —Å—é–¥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:", reply_markup=inline_kb)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ" –∏–∑ –º–µ–Ω—é
@dp.message_handler(lambda message: message.text == "üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ")
async def search_button_handler(message: types.Message):
    inline_kb = InlineKeyboardMarkup()
    inline_kb.add(InlineKeyboardButton(
        text="üîé –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫", 
        switch_inline_query_current_chat="" # –ê–≤—Ç–æ-–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–º–µ–Ω–∏ –±–æ—Ç–∞
    ))
    await message.answer("–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ª—é–±–∏–º–æ–µ –∞–Ω–∏–º–µ:", reply_markup=inline_kb)

@dp.message_handler(lambda message: message.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile(message: types.Message):
    await message.answer(f"üë§ <b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b> {message.from_user.first_name}\nID: <code>{message.from_user.id}</code>")

@dp.message_handler(lambda message: message.text == "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
async def schedule(message: types.Message):
    await message.answer("üìÖ <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</b> –ù–æ–≤—ã–µ —Å–µ—Ä–∏–∏ –≤—ã—Ö–æ–¥—è—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ! –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫.")

@dp.message_handler(lambda message: message.text == "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
async def about(message: types.Message):
    await message.answer("üé¨ <b>Zuxa Anime</b> ‚Äî –ª—É—á—à–∏–π –±–æ—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∏–º–µ –æ–Ω–ª–∞–π–Ω.")

# --- –ò–ù–õ–ê–ô–ù –ü–û–ò–°–ö –ò –û–¢–ü–†–ê–í–ö–ê –í–ò–î–ï–û ---
@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query}&limit=15&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            if resp.status == 200:
                data = await resp.json()
                for i, item in enumerate(data.get("results", [])):
                    m_data = item.get("material_data", {})
                    title = item.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
                    link = item.get('link')
                    poster = m_data.get("poster_url", "https://via.placeholder.com/400x600.png?text=No+Poster")
                    
                    # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥ –≤–∏–¥–µ–æ
                    markup = InlineKeyboardMarkup()
                    markup.add(InlineKeyboardButton(text="‚ñ∂Ô∏è –°–ú–û–¢–†–ï–¢–¨ –û–ù–õ–ê–ô–ù", url=link))

                    results.append(types.InlineQueryResultArticle(
                        id=str(i),
title=title,
                        description=f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {m_data.get('shikimori_rating', '‚Äî')}",
                        thumb_url=poster,
                        input_message_content=types.InputTextMessageContent(
                            message_text=(
                                f"üé¨ <b>{title}</b>\n\n"
                                f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {m_data.get('shikimori_rating', '‚Äî')}\n"
                                f"üé≠ –ñ–∞–Ω—Ä—ã: {', '.join(m_data.get('anime_genres', ['–ù–µ —É–∫–∞–∑–∞–Ω—ã']))}\n\n"
                                f"üçø <b>–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!</b>"
                            ),
                            parse_mode="HTML",
                            disable_web_page_preview=False 
                        ),
                        reply_markup=markup
                    ))
    
    await bot.answer_inline_query(inline_query.id, results=results, cache_time=1)

# --- –ó–ê–ü–£–°–ö ---
async def main():
    app = web.Application()
    app.router.add_get('/kodik.txt', handle_kodik_confirm)
    runner = web.AppRunner(app)
    await runner.setup()
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    try:
        await dp.start_polling()
    finally:
        await bot.close()

if __name__ == '__main__':
    asyncio.run(main())
