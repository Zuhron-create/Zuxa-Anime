import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# –¢–æ–∫–µ–Ω –±–µ—Ä–µ–º –∏–∑ —Ç–≤–æ–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ Render
API_TOKEN = os.getenv("BOT_TOKEN")
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
KODIK_CONFIRM_TEXT = "kodik2349989754"

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(KeyboardButton("üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ"))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    return keyboard

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    await message.answer(
        "üëã <b>Zuxa Anime</b> –∑–∞–ø—É—â–µ–Ω!\n\n"
        "–î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏: <code>@ZuxaAnime_bot –ù–∞—Ä—É—Ç–æ</code>",
        reply_markup=main_menu()
    )

# –†–ê–ë–û–ß–ê–Ø –ö–ù–û–ü–ö–ê –ü–û–ò–°–ö–ê
@dp.message_handler(lambda message: message.text == "üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ")
async def search_hint(message: types.Message):
    inline_kb = InlineKeyboardMarkup()
    inline_kb.add(InlineKeyboardButton(
        text="üöÄ –û—Ç–∫—Ä—ã—Ç—å –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫", 
        switch_inline_query_current_chat="" # –≠—Ç–æ —Å–∞–º–æ –≤—Å—Ç–∞–≤–∏—Ç –∏–º—è –±–æ—Ç–∞
    ))
    await message.answer("–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫:", reply_markup=inline_kb)

# –ò–ù–õ–ê–ô–ù –ü–û–ò–°–ö –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú –°–°–´–õ–û–ö
@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query}&limit=10&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            if resp.status == 200:
                data = await resp.json()
                for i, item in enumerate(data.get("results", [])):
                    title = item.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
                    link = item.get('link', '')
                    
                    # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò URLHostIsEmpty:
                    if link.startswith('//'):
                        link = 'https:' + link
                    
                    if not link.startswith('http'):
                        continue # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏

                    poster = item.get("material_data", {}).get("poster_url", "https://via.placeholder.com/150")
                    
                    markup = InlineKeyboardMarkup()
                    markup.add(InlineKeyboardButton(text="üçø –°–ú–û–¢–†–ï–¢–¨ –í –ß–ê–¢–ï", url=link))

                    results.append(types.InlineQueryResultArticle(
                        id=str(i),
                        title=title,
                        thumb_url=poster,
                        input_message_content=types.InputTextMessageContent(
                            message_text=f"üé¨ <b>{title}</b>\n\nüçø –ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ Telegram!",
                            parse_mode="HTML",
                            disable_web_page_preview=False
                        ),
                        reply_markup=markup
                    ))

    await bot.answer_inline_query(inline_query.id, results=results, cache_time=1)

# –ó–ê–ü–£–°–ö
async def main():
    app = web.Application()
    app.router.add_get('/kodik.txt', lambda r: web.Response(text=KODIK_CONFIRM_TEXT))
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, '0.0.0.0', int(os.environ.get("PORT", 8080)))
    await site.start()
    await dp.start_polling()

if __name__ == '__main__':
    asyncio.run(main())
