import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# –¢–æ–∫–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Render (Environment Variables)
API_TOKEN = os.getenv("BOT_TOKEN")
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
KODIK_CONFIRM_TEXT = "kodik2349989754"

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(KeyboardButton("üîç –ü–æ–∏—Å–∫"))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    return keyboard

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    await message.answer(
        "üëã <b>Zuxa Anime</b> –∑–∞–ø—É—â–µ–Ω!\n\n–ò—Å–ø–æ–ª—å–∑—É–π –º–µ–Ω—é –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∞–Ω–∏–º–µ –∏ —Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –ø—Ä—è–º–æ –≤ Telegram.",
        reply_markup=main_menu()
    )

# --- –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö –ú–ï–ù–Æ ---
@dp.message_handler(lambda message: message.text == "üîç –ü–æ–∏—Å–∫")
async def search_button(message: types.Message):
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton(
        text="üöÄ –ù–∞–∂–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞", 
        switch_inline_query_current_chat="" 
    ))
    await message.answer("–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫:", reply_markup=markup)

@dp.message_handler(lambda message: message.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile_handler(message: types.Message):
    await message.answer(f"üë§ <b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b>\n–ò–º—è: {message.from_user.first_name}\nID: <code>{message.from_user.id}</code>")

@dp.message_handler(lambda message: message.text == "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
async def schedule_handler(message: types.Message):
    await message.answer("üìÖ <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</b>\n–ù–æ–≤—ã–µ —Å–µ—Ä–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –æ–∑–≤—É—á–∫–∏!")

# --- –ò–ù–õ–ê–ô–ù –ü–û–ò–°–ö (–í–∏–¥–µ–æ –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ) ---
@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query}&limit=10&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            if resp.status == 200:
                data = await resp.json()
                for i, item in enumerate(data.get("results", [])):
                    title = item.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
                    link = item.get('link', '')
                    
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø–ª–µ–µ—Ä–∞
                    if link.startswith('//'):
                        link = 'https:' + link
                    
                    if not link.startswith('http'): continue

                    poster = item.get("material_data", {}).get("poster_url", "https://via.placeholder.com/150")

                    results.append(types.InlineQueryResultArticle(
                        id=str(i),
                        title=title,
                        thumb_url=poster,
                        description="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ",
                        input_message_content=types.InputTextMessageContent(
                            # –§–æ–∫—É—Å: –ø—É—Å—Ç–∞—è —Å—Å—ã–ª–∫–∞-–Ω–µ–≤–∏–¥–∏–º–∫–∞ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç Telegram –ø–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–µ—Ä –Ω–∞–¥ —Ç–µ–∫—Å—Ç–æ–º
                            message_text=f"<a href='{link}'>‚†Ä</a>üé¨ <b>{title}</b>\n\nüçø –í–∏–¥–µ–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è –≤—ã—à–µ. –ù–∞–∂–º–∏ 'Play'!",
                            parse_mode="HTML",
                            disable_web_page_preview=False # –≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –ø–ª–µ–µ—Ä –≤ —á–∞—Ç–µ
                        )
                    ))
    await bot.answer_inline_query(inline_query.id, results=results, cache_time=1)

# --- –ó–ê–ü–£–°–ö ---
async def main():
    # –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ—Ä—Ç–∞ Render
    app = web.Application()
app.router.add_get('/kodik.txt', lambda r: web.Response(text=KODIK_CONFIRM_TEXT))
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, '0.0.0.0', int(os.environ.get("PORT", 8080)))
    await site.start()
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (—É–±–µ–¥–∏—Å—å, —á—Ç–æ Webhook —É–¥–∞–ª–µ–Ω!)
    await dp.start_polling()

if __name__ == '__main__':
    asyncio.run(main())
