import os
import asyncio
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, WebAppInfo

# –ë–µ—Ä–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Render
API_TOKEN = os.getenv("BOT_TOKEN")
# URL —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ Render (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://zuxa-anime.onrender.com)
# –ú—ã –ø–æ–ª—É—á–∏–º –µ–≥–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
APP_URL = os.getenv("APP_URL") 

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –±–æ–ª—å—à–æ–π –∫–Ω–æ–ø–∫–æ–π Mini App
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    # –≠—Ç–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Äî –æ–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App
    keyboard.add(KeyboardButton(
        text="üé¨ –û–¢–ö–†–´–¢–¨ –ö–ò–ù–û–¢–ï–ê–¢–†", 
        web_app=WebAppInfo(url=APP_URL) if APP_URL else WebAppInfo(url="https://google.com")
    ))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    return keyboard

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    await message.answer(
        "üçø <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Zuxa Cinema!</b>\n\n"
        "–¢–µ–ø–µ—Ä—å –Ω–∞—à–µ –∞–Ω–∏–º–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –≤–∏–¥–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–∏ Telegram.\n\n"
        "–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ üëá",
        reply_markup=main_menu()
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –¥–ª—è –ø–æ—Ä—è–¥–∫–∞
@dp.message_handler(lambda message: message.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile(message: types.Message):
    await message.answer(f"üë§ –ü—Ä–æ—Ñ–∏–ª—å: <b>{message.from_user.first_name}</b>")

@dp.message_handler(lambda message: message.text == "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
async def schedule(message: types.Message):
    await message.answer("üìÖ –ù–æ–≤—ã–µ —Å–µ—Ä–∏–∏ –≤—ã—Ö–æ–¥—è—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ Mini App!")

# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –±–æ—Ç–∞ –≤ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Mini App
async def handle_index(request):
    # –ß–∏—Ç–∞–µ–º —Ç–≤–æ–π —Ñ–∞–π–ª index.html –∏ –æ—Ç–¥–∞–µ–º –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    with open('index.html', 'r', encoding='utf-8') as f:
        html = f.read()
    return web.Response(text=html, content_type='text/html')

async def main():
    app = web.Application()
    app.router.add_get('/', handle_index) # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    app.router.add_get('/kodik.txt', lambda r: web.Response(text="kodik2349989754"))
    
    runner = web.AppRunner(app)
    await runner.setup()
    # –ü–æ—Ä—Ç 8080 –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è Render
    site = web.TCPSite(runner, '0.0.0.0', int(os.environ.get("PORT", 8080)))
    await site.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    await dp.start_polling()

if __name__ == '__main__':
    asyncio.run(main())
