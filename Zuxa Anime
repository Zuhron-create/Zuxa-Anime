import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –±–µ—Ä–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
API_TOKEN = os.getenv("BOT_TOKEN")
# –¢–≤–æ–π API —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ Kodik
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2" 
# –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏—è —Å–∞–π—Ç–æ–º
KODIK_CONFIRM_TEXT = "kodik2349989754"

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# --- –ë–õ–û–ö –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –î–õ–Ø KODIK ---
async def handle_kodik_confirm(request):
    return web.Response(text=KODIK_CONFIRM_TEXT)

# --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê ---
@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    await message.reply(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø Zuxa Anime.\n\n"
        "üîç –ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∞–Ω–∏–º–µ, –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏ –º–æ—ë –∏–º—è –≤ –ª—é–±–æ–º —á–∞—Ç–µ:\n"
        "@ZuxaAnime_bot –ù–∞—Ä—É—Ç–æ",
        parse_mode="Markdown"
    )

@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query_text = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query_text}&limit=10&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        try:
            async with session.get(url) as response:
                if response.status == 200:
                    data = await response.json()
                    for i, item in enumerate(data.get("results", [])):
                        m_data = item.get("material_data", {})
                        poster = m_data.get("poster_url") or "https://via.placeholder.com/400x600.png?text=No+Poster"
                        
                        results.append(
                            types.InlineQueryResultArticle(
                                id=str(i),
                                title=item.get("title", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"),
                                thumb_url=poster,
                                description=f"–ì–æ–¥: {item.get('year')} | –†–µ–π—Ç–∏–Ω–≥: {m_data.get('shikimori_rating', '‚Äî')}",
                                input_message_content=types.InputTextMessageContent(
                                    message_text=(
                                        f"üé¨ *{item.get('title')}*\n\n"
                                        f"üìñ {m_data.get('description', '–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è...')[:400]}...\n\n"
                                        f"üçø
