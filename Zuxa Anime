import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ï—Å–ª–∏ Render —Å–Ω–æ–≤–∞ –Ω–∞–ø–∏—à–µ—Ç "Token is invalid", –∑–∞–º–µ–Ω–∏ os.getenv("BOT_TOKEN") 
# –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –≤ –∫–∞–≤—ã—á–∫–∞—Ö –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: API_TOKEN = "—Ç–≤–æ–π_—Ç–æ–∫–µ–Ω"
API_TOKEN = os.getenv("BOT_TOKEN") 
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
KODIK_CONFIRM_TEXT = "kodik2349989754"

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (–ö–ù–û–ü–ö–ò) ---
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.row(KeyboardButton("üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ"))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    keyboard.row(KeyboardButton("‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ"))
    return keyboard

# –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Kodik (—á—Ç–æ–±—ã —Ñ–∞–π–ª kodik.txt —Ä–∞–±–æ—Ç–∞–ª)
async def handle_kodik_confirm(request):
    return web.Response(text=KODIK_CONFIRM_TEXT)

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    await message.answer(
        "üëã <b>Zuxa Anime</b> –∑–∞–ø—É—â–µ–Ω!\n\n"
        "–î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –≤ –ª—é–±–æ–º —á–∞—Ç–µ: <code>@ZuxaAnime_bot –ù–∞—Ä—É—Ç–æ</code>",
        reply_markup=main_menu()
    )

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ —Å –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï–ú
@dp.message_handler(lambda message: message.text == "üîç –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ")
async def search_hint(message: types.Message):
    inline_kb = InlineKeyboardMarkup()
    inline_kb.add(InlineKeyboardButton(
        text="üöÄ –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)", 
        switch_inline_query_current_chat="" # –≠—Ç–æ —Å–∞–º–æ –≤—Å—Ç–∞–≤–∏—Ç @ZuxaAnime_bot
    ))
    await message.answer("–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:", reply_markup=inline_kb)

@dp.message_handler(lambda message: message.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile(message: types.Message):
    await message.answer(f"üë§ <b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b> {message.from_user.first_name}\nID: <code>{message.from_user.id}</code>")

@dp.message_handler(lambda message: message.text == "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
async def schedule(message: types.Message):
    await message.answer("üìÖ <b>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</b> –ù–æ–≤—ã–µ —Å–µ—Ä–∏–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å! –ò—â–∏ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫.")

@dp.message_handler(lambda message: message.text == "‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
async def about(message: types.Message):
    await message.answer("üé¨ <b>Zuxa Anime</b> ‚Äî —Ç–≤–æ–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –≤ –º–∏—Ä –∞–Ω–∏–º–µ.")

# --- –ò–ù–õ–ê–ô–ù –ü–û–ò–°–ö –ò –û–¢–ü–†–ê–í–ö–ê –í–ò–î–ï–û (HTML —Ä–µ–∂–∏–º) ---
@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query}&limit=10&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            if resp.status == 200:
                data = await resp.json()
                for i, item in enumerate(data.get("results", [])):
                    m_data = item.get("material_data", {})
                    title = item.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
                    link = item.get('link')
                    poster = m_data.get("poster_url", "https://via.placeholder.com/150")
                    
                    # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–ª–µ–µ—Ä–∞ –≤ —á–∞—Ç–µ
                    markup = InlineKeyboardMarkup()
                    markup.add(InlineKeyboardButton(text="üçø –°–ú–û–¢–†–ï–¢–¨", url=link))

                    results.append(types.InlineQueryResultArticle(
                        id=str(i),
                        title=title,
                        description=f"–°–º–æ—Ç—Ä–µ—Ç—å: {title}",
                        thumb_url=poster,
                        input_message_content=types.InputTextMessageContent(
                            message_text=f"üé¨ <b>{title}</b>\n\nüçø –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!",
parse_mode="HTML",
                            disable_web_page_preview=False # –í–ö–õ–Æ–ß–ê–ï–¢ –ø–ª–µ–µ—Ä –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ
                        ),
                        reply_markup=markup
                    ))

    await bot.answer_inline_query(inline_query.id, results=results, cache_time=1)

# --- –ó–ê–ü–£–°–ö –í–ï–ë-–°–ï–†–í–ï–†–ê –ò –ë–û–¢–ê ---
async def main():
    app = web.Application()
    app.router.add_get('/kodik.txt', handle_kodik_confirm)
    
    runner = web.AppRunner(app)
    await runner.setup()
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()

    try:
        await dp.start_polling()
    finally:
        await bot.close()

if __name__ == '__main__':
    asyncio.run(main())
