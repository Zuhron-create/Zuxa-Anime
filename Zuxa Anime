import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types

# --- –î–ê–ù–ù–´–ï –ò–ó –¢–í–û–ò–• –°–ö–†–ò–ù–®–û–¢–û–í ---
API_TOKEN = os.getenv("BOT_TOKEN") # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ Environment –Ω–∞ Render
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2" #
KODIK_CONFIRM_TEXT = "kodik2349989754" #

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (Kodik –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å –µ–≥–æ –∑–¥–µ—Å—å)
async def handle_kodik_confirm(request):
    return web.Response(text=KODIK_CONFIRM_TEXT)

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    await message.reply("üëã Zuxa Anime –∑–∞–ø—É—â–µ–Ω! –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–∏—Å–∫: @ZuxaAnime_bot")

@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query}&limit=10&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as resp:
            if resp.status == 200:
                data = await resp.json()
                for i, item in enumerate(data.get("results", [])):
                    m_data = item.get("material_data", {})
                    results.append(types.InlineQueryResultArticle(
                        id=str(i),
                        title=item.get("title", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"),
                        thumb_url=m_data.get("poster_url"),
                        input_message_content=types.InputTextMessageContent(
                            message_text=f"üé¨ *{item.get('title')}*\n\nüçø [–°–º–æ—Ç—Ä–µ—Ç—å]({item.get('link')})",
                            parse_mode="Markdown"
                        )
                    ))
    await bot.answer_inline_query(inline_query.id, results=results, cache_time=1)

async def main():
    # –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ñ–∞–π–ª–∞ kodik.txt
    app = web.Application()
    app.router.add_get('/kodik.txt', handle_kodik_confirm)
    
    runner = web.AppRunner(app)
    await runner.setup()
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    try:
        await dp.start_polling()
    finally:
        await bot.close()

if __name__ == '__main__':
    asyncio.run(main())
