import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, WebAppInfo

# Безопасное получение токена
RAW_TOKEN = os.getenv("BOT_TOKEN")
API_TOKEN = RAW_TOKEN.strip() if RAW_TOKEN else None
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
APP_URL = os.getenv("APP_URL")

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# Прокси для обхода ограничений поддоменов onrender.com
async def proxy_kodik(request):
    q_type = request.query.get('type', 'list')
    title = request.query.get('title', '')
    
    url = f"https://kodikapi.com/list?token={KODIK_TOKEN}&types=anime-serial&limit=15&with_material_data=true&sort=shikimori_rating"
    if q_type == 'search':
        url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={title}&with_material_data=true"
        
    # Заголовки, чтобы Kodik думал, что мы - обычный браузер
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Origin': 'https://kodik.biz',
        'Referer': 'https://kodik.biz/'
    }

    async with aiohttp.ClientSession() as session:
        try:
            async with session.get(url, headers=headers) as resp:
                data = await resp.json()
                return web.json_response(data, headers={'Access-Control-Allow-Origin': '*'})
        except Exception:
            return web.json_response({"error": "server error"}, status=500)

async def handle_index(request):
    return web.FileResponse('index.html')

async def main():
    # Удаляем вебхуки и конфликты
    await bot.delete_webhook(drop_pending_updates=True)
    
    app = web.Application()
    app.router.add_get('/', handle_index)
    app.router.add_get('/api/anime', proxy_kodik)
    
    runner = web.AppRunner(app)
    await runner.setup()
    # Автоматический выбор порта Render
    port = int(os.environ.get("PORT", 10000))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    print(f"Server is LIVE on port {port}")
    await dp.start_polling()

if __name__ == '__main__':
    asyncio.run(main())
