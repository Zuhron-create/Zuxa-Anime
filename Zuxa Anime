import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –±–µ—Ä–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
API_TOKEN = os.getenv("BOT_TOKEN")
# –¢–≤–æ–π API —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ Kodik (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω)
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2" 
# –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏—è —Å–∞–π—Ç–æ–º (–∏–∑ —Ç–≤–æ–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞)
KODIK_CONFIRM_TEXT = "kodik2349989754"

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# --- –ë–õ–û–ö –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –î–õ–Ø KODIK ---
# –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã Kodik –æ–¥–æ–±—Ä–∏–ª —Ç–≤–æ–π –¥–æ–º–µ–Ω –Ω–∞ Render
async def handle_kodik_confirm(request):
    return web.Response(text=KODIK_CONFIRM_TEXT)

# --- –õ–û–ì–ò–ö–ê –ë–û–¢–ê ---
@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    await message.reply(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø Zuxa Anime.\n\n"
        "üîç –ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∞–Ω–∏–º–µ, –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏ –º–æ—ë –∏–º—è –≤ –ª—é–±–æ–º —á–∞—Ç–µ:\n"
        "@ZuxaAnime_bot –ù–∞—Ä—É—Ç–æ",
        parse_mode="Markdown"
    )

@dp.inline_handler()
async def inline_search(inline_query: types.InlineQuery):
    query_text = inline_query.query or "–ù–∞—Ä—É—Ç–æ"
    
    # –ó–∞–ø—Ä–æ—Å –∫ API Kodik
    url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={query_text}&limit=10&with_material_data=true"
    
    results = []
    async with aiohttp.ClientSession() as session:
        try:
            async with session.get(url) as response:
                if response.status == 200:
                    data = await response.json()
                    for i, item in enumerate(data.get("results", [])):
                        m_data = item.get("material_data", {})
                        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç–µ—Ä –∏–ª–∏ —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
                        poster = m_data.get("poster_url") or "https://via.placeholder.com/400x600.png?text=No+Poster"
                        
                        results.append(
                            types.InlineQueryResultArticle(
                                id=str(i),
                                title=item.get("title", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"),
                                thumb_url=poster,
                                description=f"–ì–æ–¥: {item.get('year')} | –†–µ–π—Ç–∏–Ω–≥: {m_data.get('shikimori_rating', '‚Äî')}",
                                input_message_content=types.InputTextMessageContent(
                                    message_text=(
                                        f"üé¨ *{item.get('title')}*\n\n"
                                        f"üìñ {m_data.get('description', '–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è...')[:400]}...\n\n"
                                        f"üçø [–°–º–æ—Ç—Ä–µ—Ç—å –≤ Zuxa Anime]({item.get('link')})"
                                    ),
                                    parse_mode="Markdown"
                                )
                            )
                        )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}")

    await bot.answer_inline_query(inline_query.id, results=results, cache_time=1)

# --- –ó–ê–ü–£–°–ö –í–ï–ë-–°–ï–†–í–ï–†–ê (–î–ª—è Render –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Kodik) ---
async def on_startup(dp):
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")

if name == 'main':
    # –°–æ–∑–¥–∞–µ–º aiohttp –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ Render
    app = web.Application()
    
    # –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Kodik (https://—Ç–≤–æ–π-—Å–∞–π—Ç.onrender.com/kodik.txt)
    app.router.add_get('/kodik.txt', handle_kodik_confirm)
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ –º–µ—à–∞–ª
    loop = asyncio.get_event_loop()
    
    # –ó–∞–ø—É—Å–∫ –ø–æ–ª–ª–∏–Ω–≥–∞ aiogram
    def start_bot():
        executor.start_polling(dp, skip_updates=True, on_startup=on_startup)

    import threading
    bot_thread = threading.Thread(target=start_bot)
    bot_thread.start()

    # –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É Render
    port = int(os.environ.get("PORT", 8080))
    web.run_app(app, port=port)
