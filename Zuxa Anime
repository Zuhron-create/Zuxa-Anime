import asyncio
import sqlite3
import requests
import datetime
import urllib3
import os
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import (
    InlineQueryResultArticle, 
    InputMessageContent, 
    InlineKeyboardMarkup, 
    InlineKeyboardButton
)

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É SSL –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –∏–∑ –ª—é–±–æ–π —Ç–æ—á–∫–∏ –º–∏—Ä–∞
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# =========================================================
# ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ü–û–õ–ù–ò –°–í–û–ò –î–ê–ù–ù–´–ï)
# =========================================================
BOT_TOKEN = '8421050178:AAHysF0xfwsq7U3uscEMcsocOMJ6d_xfyEQ'
MY_USERNAME = "@Zuhroniddin" 
CHAT_RU = "https://t.me/—Ç–≤–æ–π_—á–∞—Ç_—Ä—É" 
API_TOKEN = "" # –û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, –ø–æ–∫–∞ AniLibria –Ω–µ –¥–∞—Å—Ç —Ç–æ–∫–µ–Ω
# =========================================================

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
def init_db():
    conn = sqlite3.connect('anime_bot.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS history 
                      (user_id INTEGER, anime_id TEXT, last_episode INTEGER, 
                       PRIMARY KEY (user_id, anime_id))''')
    conn.commit()
    conn.close()

init_db()

# --- –§–£–ù–ö–¶–ò–ò API ---
def search_anime(query):
    url = "https://api.anilibria.tv/v3/title/search"
    params = {'search': query, 'limit': 10}
    headers = {'User-Agent': 'Mozilla/5.0'}
    try:
        res = requests.get(url, params=params, headers=headers, verify=False, timeout=10)
        if res.status_code == 200:
            data = res.json()
            return data if isinstance(data, list) else data.get('list', [])
        return []
    except: return []

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîé –ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ", switch_inline_query_current_chat="")],
        [InlineKeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="profile"), 
         InlineKeyboardButton(text="üóì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ", callback_data="schedule")],
        [InlineKeyboardButton(text="‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ", callback_data="about")]
    ])
    await message.answer("üçø ZuxaAnime –∑–∞–ø—É—â–µ–Ω!\n–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä 24/7.", reply_markup=kb, parse_mode="Markdown")

@dp.callback_query(F.data == "about")
async def about(callback: types.CallbackQuery):
    text = (f"üíª –û –ø—Ä–æ–µ–∫—Ç–µ ZuxaAnime\n\n–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–ª–∞–∫–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.\n"
            f"üöÄ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: {MY_USERNAME}")
    kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back")]])
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="Markdown")

@dp.callback_query(F.data == "back")
async def back(callback: types.CallbackQuery):
    await callback.message.delete()
    await cmd_start(callback.message)

@dp.inline_query()
async def inline_search(query: types.InlineQuery):
    if len(query.query) < 2: return
    results = await asyncio.to_thread(search_anime, query.query)
    items = []
    for a in results:
        poster = f"https://www.anilibria.tv{a['posters']['original']['url']}"
        items.append(InlineQueryResultArticle(
            id=str(a['id']),
            title=a['names']['ru'],
            thumbnail_url=poster,
            input_message_content=InputMessageContent(message_text=f"üé¨ {a['names']['ru']}"),
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[[
                InlineKeyboardButton(text="‚ñ∂Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å", callback_data=f"watch_{a['id']}")
            ]])
        ))
    await query.answer(items, cache_time=1)

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
