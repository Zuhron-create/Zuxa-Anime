import os
import asyncio
import aiohttp
from aiohttp import web
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, WebAppInfo

# –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–≤–æ–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ Render
API_TOKEN = os.getenv("BOT_TOKEN")
KODIK_TOKEN = "388702680a73bae2d95a7ef5b7b013f2"
APP_URL = os.getenv("APP_URL")

bot = Bot(token=API_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot)

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ –ë–û–¢–ê ---
def main_menu():
    keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(KeyboardButton(
        text="üé¨ –û–¢–ö–†–´–¢–¨ –ö–ò–ù–û–¢–ï–ê–¢–†", 
        web_app=WebAppInfo(url=APP_URL)
    ))
    keyboard.row(KeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å"), KeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"))
    return keyboard

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    await message.answer(
        "üçø <b>Zuxa Anime</b> –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\n\n–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∏–º–µ.",
        reply_markup=main_menu()
    )

# --- –ü–†–û–ö–°–ò-–°–ï–†–í–ï–† –° –ú–ê–°–ö–ò–†–û–í–ö–û–ô ---
async def proxy_kodik(request):
    query_type = request.query.get('type', 'list')
    search_query = request.query.get('title', '')
    
    if query_type == 'search':
        url = f"https://kodikapi.com/search?token={KODIK_TOKEN}&title={search_query}&with_material_data=true"
    else:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–µ—Ä–∏–∞–ª—ã –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        url = f"https://kodikapi.com/list?token={KODIK_TOKEN}&types=anime-serial&limit=15&with_material_data=true&sort=shikimori_rating"
        
    # –ú–∞—Å–∫–∏—Ä—É–µ–º—Å—è –ø–æ–¥ –æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä, —á—Ç–æ–±—ã Kodik –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª Render
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
        'Referer': 'https://kodik.biz/'
    }

    async with aiohttp.ClientSession() as session:
        try:
            async with session.get(url, headers=headers) as resp:
                if resp.status == 200:
                    data = await resp.json()
                    return web.json_response(data, headers={'Access-Control-Allow-Origin': '*'})
                else:
                    return web.json_response({"error": "Kodik returned error"}, status=resp.status)
        except Exception as e:
            return web.json_response({"error": str(e)}, status=500)

# --- –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
async def handle_index(request):
    if os.path.exists('index.html'):
        return web.FileResponse('index.html')
    return web.Response(text="index.html –Ω–µ –Ω–∞–π–¥–µ–Ω", status=404)

async def main():
    # 1. –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –æ—à–∏–±–∫—É Conflict –≤ –ª–æ–≥–∞—Ö
    await bot.delete_webhook(drop_pending_updates=True)
    
    app = web.Application()
    app.router.add_get('/', handle_index)
    app.router.add_get('/api/anime', proxy_kodik)
    
    # –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É Render
    runner = web.AppRunner(app)
    await runner.setup()
    port = int(os.environ.get("PORT", 8080))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    print(f"–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    try:
        await dp.start_polling()
    finally:
        await bot.session.close()

if __name__ == '__main__':
    asyncio.run(main())
